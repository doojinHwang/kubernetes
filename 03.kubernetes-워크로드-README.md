## 1) YAML 및 오브젝트
### YAML
YAML Ain't Markup Language(YAML은 마크업 언어가 아니다)라는 재귀적인 이름에서 유래...
(중요) YAML에서는 tab키를 인식하질 않는다.(사용x)
들여쓰기는 보통 2칸으로 사용  
[YAML(https://yaml.org)](https://yaml.org/)

스칼라/스트링, 리스트/어레이, 해시/딕셔너리 3가지 많이 사용.

#### (1) 스칼라/스트링
-단순 간단한 문자 또는 문자열
-쌍/홑 따옴표를 사용하여 둘러쌀 수 있으나 일반적으로 사용하질 않는다.
-한줄에 하나의 문자열이다.
-순서가 없다.  

#### (2) 리스트/어레이
-스칼라 앞에 '-'을 붙이고 '-' 와 문자 사이는 공백이 있어야 한다.
 ==> - abc  
-리스트는 순서가 있다.
-한 줄에 하나의 요소를 표현  

#### (3) 해시/딕셔너리
- key: value 형태, 이때 주의 할 점은 value 앞은 공백으로 띄워쓰기 필수
 ==> 예) name: 홍길동  

#### (4) 해시의 리스트

#### (5) 리스트의 해시

### YAML 문법
-YAML 문자열은 UTF-8 또는 UTF-16의 유니코드 문자집합 사용  
(참고) 유닉스에서 줄바꿈(개행)을 CRLF를 인식못하고 LF만 인식함  
-공백문자를 이용하여 들어쓰기(tab들어쓰기 사용하질 않음)  
-하나의 스트림에 있는 여러 개의 YAML 문서를 구분하기 위해  
 시작은 하이픈 3개(---), 끝은 마침표 3개(...)를 사용  
-주석은 #으로 표시, 한 줄이 끝날 때까지 유효
-YAML 파일릐 확장자는 yml 또는 yaml  

    apiVersion: v1
    kind: pod
    metadata:
      name: myapp-pod
      lables:
        app: myapp
        type: frontend
    spec:
      containers:
        - name: nginx-container
          image: nginx
필수 필드:  
-apiVersion: 오브젝트를 생성하기 위한 API버전(2019.97월 기준 현재 v1만 존재)
==> kubectl api-versions 명령결과에서 앞에 그룹이 없는 것만 사용가능
-kind: 오브젝트 종류(pod, services, replcaset, deployment 등등)  
-metadata: name, UID, namespace 등을 포함하는 기본적인 정보  
-spec: 오브젝트의 상태 정의, 정의할 요소는 정의하고자 하는 오브젝트의 종류에 따라 다름  

<hr/>
<br><br><br>

## 2) 워크로드 파드

### 파드정의(YAML문서작성)
YAML 작성: 파드를 생성할 수 있는 YAML(yml) 파일 작성

    cccr-pod.yml
        apiVersion: v1
        kind: Pod
        metadata:
          name: sample-pod
        spec:
          containers:
          - image: dj/sample
            name: sample
            ports:
            - containerPort: 8080
              protocol: TCP
              
(참고) 오브젝트 리소스의 API확인: 
    
    kubectl api-resources (<== kubectl explain)

    NAME                              SHORTNAMES   APIGROUP                       NAMESPACED   KIND
    bindings                                                                      true         Binding
    componentstatuses                 cs                                          false        ComponentStatus
    configmaps                        cm                                          true         ConfigMap
    endpoints                         ep                                          true         Endpoints
    events                            ev                                          true         Event
    limitranges                       limits                                      true         LimitRange
    namespaces                        ns                                          false        Namespace
    nodes                             no                                          false        Node
    --중략--

 
### 파드생성
    kubectl create -f sample-pod.yml
결과메시지: pod/ccr-pod created
 
### 파드 목록 확인
    kubectl get pods

### 실행중인 파드의 정의 확인
    kubectl get pods sample-pod -o yml

⇒ (참고) yml 지정으로 error 발생시 yaml 또는 json


### 파드의 자세한 정보 확인
    kubectl describe pods sample-pod

### 파드 로그 확인
> kubectl logs <파드명>

    kubectl logs sample-pod

다중 컨테이너를 가지고 있는 경우 -c옵션을 사용하여 컨테이너(cccr)를 지정
> kubectl logs <파드명> -c <컨테이너명>

    kubectl logs sample-pod -c sample


### 파드 포트 포워딩
    kubectl port-forward sample-pod 80:8080 <== 클라이언트(80):(pod:8080)
    Forwarding from 127.0.0.1:8080 -> 80
    Forwarding from [::1]:8080 -> 80

확인은 : ./curl http://localhost
⇒ 80 prot는 생략 된 상태.
 


<br><br><br>

## 3) label


### 라벨을 사용한 포드정의
sample-pod-width-label.yml작성

#### 생성

    kubectl create -f sample-pod-width-label.yml

### 파드의 라벨 확인

#### get pod --show-labels

    kubectl get po --show-labels
    
    (결과샘플)-------------------------------------------------------------------
    NAME                    READY   STATUS      RESTARTS   AGE    LABELS
    sample-44pmh            0/1     Running     1          2d3h   app=sample
    sample-77kcv            0/1     Running     1          2d3h   app=sample
    sample-arg-pod          1/1     Running     1          2d     <none>
    sample-comp             1/1     Running     1          47h    <none>
    sample-configmap-pod    1/1     Running     1          47h    <none>
    sample-env-pod          1/1     Running     1          47h    <none>
    requests-pod            1/1     Running     1          27h    <none>

#### get pod -L env

    kubectl get po -L env
    
    (결과샘플)-------------------------------------------------------------------
    NAME                    READY   STATUS      RESTARTS   AGE    ENV
    sample-44pmh            0/1     Running     1          2d3h
    sample-77kcv            0/1     Running     1          2d3h
    sample-arg-pod          1/1     Running     1          2d
    sample-comp             1/1     Running     1          47h
    sample-configmap-pod    1/1     Running     1          47h
    sample-env-pod          1/1     Running     1          47h
    requests-pod            1/1     Running     1          27h

#### get pod -L env,tier
    kebuctl get po -L env,tier
    
    (결과샘플)-------------------------------------------------------------------
    NAME                    READY   STATUS      RESTARTS   AGE    ENV    TIER
    sample-44pmh            0/1     Running     1          2d3h
    sample-77kcv            0/1     Running     1          2d3h
    sample-arg-pod          1/1     Running     1          2d
    sample-comp             1/1     Running     1          47h
    sample-configmap-pod    1/1     Running     1          47h
    sample-env-pod          1/1     Running     1          47h
    requests-pod            1/1     Running     1          27h

#### pods (sample-label-pod) -o yml

    kubectl get pods sample-label-pod -o yml(yaml)
    
    (결과샘플)-------------------------------------------------------------------
    apiVersion: v1
    kind: Pod
    metadata:
      creationTimestamp: "2019-07-17T04:43:05Z"
      generateName: sample-
      labels:
        app: sample
      name: sample-44pmh
      namespace: default
      ownerReferences:
      - apiVersion: apps/v1
        blockOwnerDeletion: true
        controller: true
        kind: ReplicaSet
        name: sample
        uid: 81682395-a5ce-4df8-b6c9-2f9d5c590a37
      resourceVersion: "121627"
      selfLink: /api/v1/namespaces/default/pods/cccr-44pmh
      uid: 44f87fff-ab32-4af0-8527-4e227a25323d
    spec:
      containers:
      - image: dj/sample
        imagePullPolicy: Always
        name: sample
        ports:
        - containerPort: 8080
          protocol: TCP
        readinessProbe:
            --중략--


#### pods (sample-label-pod) -o json

    kubectl get pods sample-label-pod -o json
    
    (결과샘플)-------------------------------------------------------------------
    {
    "apiVersion": "v1",
    "kind": "Pod",
    "metadata": {
        "creationTimestamp": "2019-07-17T04:43:05Z",
        "generateName": "sample-",
        "labels": {
            "app": "sample"
        },
        "name": "sample-44pmh",
        "namespace": "default",
        "ownerReferences": [
            {
                "apiVersion": "apps/v1",
                "blockOwnerDeletion": true,
                "controller": true,
                "kind": "ReplicaSet",
                "name": "sample",
                "uid": "81682395-a5ce-4df8-b6c9-2f9d5c590a37"
            }
        ],
        "resourceVersion": "121627",
        "selfLink": "/api/v1/namespaces/default/pods/cccr-44pmh",
        "uid": "44f87fff-ab32-4af0-8527-4e227a25323d"
    },
    "spec": {
        "containers": [
            {
                "image": "dj/sample",
                "imagePullPolicy": "Always",
                "name": "sample",
                "ports": [
        --중략--                


#### describe pod sample-label-pod

    kubectl describe pod sample-label-pod
    (결과샘플)-------------------------------------------------------------------
    Name:           sample-label-pod
    Namespace:      default
    Priority:       0
    Node:           minikube/10.0.2.15
    Start Time:     Wed, 17 Jul 2019 13:43:05 +0900
    Labels:         app=sample
    Annotations:    <none>
    Status:         Running
    IP:             172.17.0.10
    Controlled By:  ReplicaSet/cccr
    Containers:
      cccr:
        Container ID:   docker://aa82d4b5752ea50d4ab3d46bf99e17717065de391bd08e337e7bf833ac6ebd55
        Image:          dj/sample
        Image ID:       docker-pullable://dj/sample@sha256:0140ce4dcecc05fc52030970d0adad7ef04e8dac82957a938fe836ee63308710
        Port:           8080/TCP
        Host Port:      0/TCP
        State:          Running
          Started:      Fri, 19 Jul 2019 14:16:32 +0900
        Last State:     Terminated
          Reason:       Error
          Exit Code:    137
          Started:      Wed, 17 Jul 2019 13:43:11 +0900
          Finished:     Thu, 18 Jul 2019 15:23:13 +0900
        Ready:          False
        Restart Count:  1
        Readiness:      exec [ls /var/ready] delay=0s timeout=1s period=10s #success=1 #failure=3
        Environment:    <none>
        Mounts:
          /var/run/secrets/kubernetes.io/serviceaccount from default-token-fx2tj (ro)
    Conditions:
      Type              Status
      Initialized       True
      Ready             False
      ContainersReady   False
      PodScheduled      True
    Volumes:
      default-token-fx2tj:
        Type:        Secret (a volume populated by a Secret)
        SecretName:  default-token-fx2tj
        Optional:    false
    QoS Class:       BestEffort
    Node-Selectors:  <none>
    Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                     node.kubernetes.io/unreachable:NoExecute for 300s
    Events:
      Type     Reason     Age                     From               Message
      ----     ------     ----                    ----               -------
      Warning  Unhealthy  2m22s (x957 over 161m)  kubelet, minikube  Readiness probe failed: ls: cannot access '/var/ready': No such file or directory



### 라벨 수정
작성중!!


### 라벨 지우기
    kubectl label pods sample-pod env=dev
    kubectl label pods sample-label-pod env=debug

⇒ 위 실행시 에러발생:
error: 'env' already has a value(dev), and --overwrite is false  

    kubectl label pods sample-label-pod env=debug --overwrite  


    kubectl label pods sample-pod env- <==env뒤에 -를 붙이면 라벨이 지워짐
    kubectl get pod --show-labels
    kubectl label pods sample-pod nev env=dev
    kubectl label pods sample-pod ev-

### 검색
    kubectl get pods --show-labels -l tier 
    kubectl get pods --show-labels l env
    kubectl get pods --show-labels -l env,tier
    kubectl get pods --show-labels -l env,tiler,relaease
    kubectl get pods --show-labels -l '!env' <= env가 아닌것 검색
    kubectl get pods --show-labels -l 'ienv,!tier'


    kubectl delete pods -l 'env in (debug)'
⇒ pod중 label의 env중 debug를 삭제하라!!!


<br><br><br>


## 4) 어노테이션
주석이락도 함, 작성자 정보표기 등에 사용

    kubectl describe pods sample-label-pod
    
⇒ 결과 내용중 'Annotations: ' 값이 있음

    kubectl annotate pods sample-label-pod devops-team/developer="DJ"
    kubectl describe pods sample-label-pod 로 확인 가능
⇒ Annotations:  devops-team/developer: DJ


<br><br><br>

## 5) 네임스페이스
리소스(Pod 등) 를 논리적으로 오브젝트를 분리  
리소스를 볼수 있는 권한 을 제한하는 목적으로도 사용  

### 네임스페이스 확인
    kubectl get namespaces
⇒ namespaces 생략시  default로 사용됨

### 네임스페이스의 오브젝트 확인 
    kubectl get all <==전부
    kubectl get all -n kube-system <== kube-system의 전부
    kubectl get pod -n kube-sytem <== kube-system의 pod

    kubectl get pods -n default
    kubectl get pods -n kube-system
    kubectl get pods -n kube-node-lease
    kubectl get pods -n kube-public


    kubectl get pods --all-namespaces <== 모든 pod의 네임스페이스를 보기
    kubectl get service --all-namespaces <== 모든 service의 네임스페이스를 보기


### 네임스페이스 생성(명령어)
    kubectl create namespace development
    
### 확인
    kubectl get namespaces


### 네임스페이스 삭제
    kubectl delete pods sample-pod <== 오브젝트 이름으로 파드 삭제
    kubectl delete -f qa-namespace.yml <==yaml파이로 삭제
    kubectl delete pods -l tier=fronted <== 오브젝트 라벨을 이용한 오브젝트 삭제

    kubectl delete ns development <==네임스페이스로 삭제
    kubectl delete namespace development
    kubectl delete ns kube-system




### 네임스페이스 생성(YAML)
    kubectl create -f qa-namespace.yml
    
    결과메시지: namespace/quality-assurance created


### 특정 네임스페이스에서 오브젝트 생성 

    kubectl create -f sample-pod.yml -n development
    
    결과메시지: pod/sample-pod created

    kubectl get pods -n development
    
    (결과샘플)--------------------------------------
    NAME       READY   STATUS    RESTARTS   AGE
    sample-pod   1/1     Running   0          17s






<hr>

<br><br><br>



## 6) 워크로드 - 컨트롤러

### (1) 라이브니스 프로브 
livenessProbe:  
⇒ 애플리케이션에서 문제가 발생했을 때 pod를 재시작 매커니즘   

#### 정보확인
    kubectl explain pod.spec.containers.livenessProbe
    kubectl explain pod.spec.containers.livenessProbe.httpGet <== httpGet확인


yml작성 후 

    kubectl create -f sample-liveness-pod.yml
    kubectl describe pods sample-liveness-pod
항목 중 Liveness: 확인  
kubectl get pods --watch  


유닉스 반복 명령어로 모니터링 : 

    while (1) {kubectl get pods; start-sleep -seconds: 1; clear}

    kubectl describe pods sample-liveness-pod-404


initialDelaySeconds: 
이값은 애플리세이션 기동시간까지의 지연시간간 설정  
이시간이 짧으면 애플리케이션이 비정장 적으로 restart됨.  



### (2) 레플리케이션 컨트롤러(rc)
pod를 복제관리.  
파드가 특정 개수만큼이 복제되고 동작하는 것을 보장  
파드와 컨트롤러는 레이블로 연결됨.  
* 레플리케이션 컨트롤러를 구성하는 3가지 요소  
-라벨셀렉터: 파드를 지정하는 라벨셀렉터  
-파드 템플릿: 새로운 파드의 복제본을 만들기 위한 파드 템플릿  
-복제수   

    kubectl get pod
    kubetctl get pod,rc <==,로 구분시 여러개 resource 확인가능

    kubectl get pod,rc --watch <== 실행시 여러개 리소스는 실시간 모니터링ㅇ 안됨
그래서
유닉스명령

    while (1) {kubectl get pod,rc; start-sleep -seconds:1; clear}


#### 컨트롤러를 삭제하면 Pod도 같이 삭제됨.

  
    kubectl get re sample-abc -o yaml
    
    kubectl edit ~ <= default 편집기로 열림
저장후 가능하면 아래 명령실행 필요.  

    kubectl replace -f cccr-re~~~*.yml <= 이미 만들어진 파일을 수정



### (3) 레플리카셋
-레플리케이션 컨트롤러(rc)의 문제점 및 기능개선 기능으로 이것으로 사용함.  
    
    kubectl api-resources | findstr replicaset
    
    (결과예시)-------------------------------------------------------------------------------------------------
    replicasets                       rs           apps                           true         ReplicaSet
    replicasets                       rs           extensions                     true         ReplicaSet
    ----------------------------------------------------------------------------------------------------------

명령 결과에서 
~1.5까지 extensions 관리하다가   
1.6부터는 apps로 관리함  
kubectl create cccr-pod-~~.yml  


    while (1) {kubectl get pod,rs; start-sleep -seconds:1; clear}
(참고) rs: replicaset  

### (4) 데몬셋
    kubectl get all -n kube-system
결과 중  daemonset .apps/kube-proxy 를....  
  
보통 외부용 보다는 내부용 agent용으로 사용할때 사용함.  
데몬셋은 복제본을 만드는 것으 아니다.  

    kubectl get nodes --show-labels

    ds:asemonset
    while (1) {kubectl get pod,ds; start-sleep -seconds:1; clear}

    kubectl label nodes minikube node=development



### (5) 잡

    while (1) {kubectl get pod,job; start-sleep -seconds:1; clear}


### (6) 크론잡

    while (1) {kubectl get pod,cronjob; start-sleep -seconds:1; clear}



<br><br><br>

